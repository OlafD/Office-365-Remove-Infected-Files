param (
    [string]$Output,
    [string]$StartDate,
    [string]$EndDate,
    $Credential
)

function WriteOutputHeader
{
    param (
        [string]$Output
    )

    "CreationTime;" | Out-File -FilePath $Output -NoNewline -Force
    "Id;" | Out-File -FilePath $Output -NoNewline -Append
    "Operation;" | Out-File -FilePath $Output -NoNewline -Append
    "OrganizationId;" | Out-File -FilePath $Output -NoNewline -Append
    "RecordType;" | Out-File -FilePath $Output -NoNewline -Append
    "UserKey;" | Out-File -FilePath $Output -NoNewline -Append
    "UserType;" | Out-File -FilePath $Output -NoNewline -Append
    "Version;" | Out-File -FilePath $Output -NoNewline -Append
    "Workload;" | Out-File -FilePath $Output -NoNewline -Append
    "ClientIP;" | Out-File -FilePath $Output -NoNewline -Append
    "ObjectId;" | Out-File -FilePath $Output -NoNewline -Append
    "UserId;" | Out-File -FilePath $Output -NoNewline -Append
    "CorrelationId;" | Out-File -FilePath $Output -NoNewline -Append
    "EventSource;" | Out-File -FilePath $Output -NoNewline -Append
    "ItemType;" | Out-File -FilePath $Output -NoNewline -Append
    "ListId;" | Out-File -FilePath $Output -NoNewline -Append
    "ListItemUniqueId;" | Out-File -FilePath $Output -NoNewline -Append
    "Site;" | Out-File -FilePath $Output -NoNewline -Append
    "UserAgent;" | Out-File -FilePath $Output -NoNewline -Append
    "WebId;" | Out-File -FilePath $Output -NoNewline -Append
    "SourceFileExtension;" | Out-File -FilePath $Output -NoNewline -Append
    "VirusInfo;" | Out-File -FilePath $Output -NoNewline -Append
    "VirusVendor;" | Out-File -FilePath $Output -NoNewline -Append
    "SiteUrl;" | Out-File -FilePath $Output -NoNewline -Append
    "SourceFileName;" | Out-File -FilePath $Output -NoNewline -Append
    "SourceRelativeUrl" | Out-File -FilePath $Output -NoNewline -Append
    "" | Out-File -FilePath $Output -Append
}

function WriteOutputLine
{
    param (
        $AuditEntry,
        [string]$Output
    )

    $AuditEntry.CreationTime + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.Id + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.Operation + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.OrganizationId + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.RecordType.ToString() + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.UserKey + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.UserType.ToString() + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.Version.ToString() + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.Workload + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.ClientIP + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.ObjectId + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.UserId + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.CorrelationId + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.EventSource + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.ItemType + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.ListId + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.ListItemUniqueId + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.Site + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.UserAgent + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.WebId + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.SourceFileExtension + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.VirusInfo + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.VirusVendor + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.SiteUrl + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.SourceFileName + ";" | Out-File -FilePath $Output -NoNewline -Append
    $AuditEntry.SourceRelativeUrl | Out-File -FilePath $Output -NoNewline -Append
    "" | Out-File -FilePath $Output -Append
}

if ($Credential -eq $null)
{
    $Credential = Get-Credential
}
 
Write-Host "Connecting to Exchange Online"
 
$exchangeSession = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $Credential -Authentication Basic -AllowRedirection
 
Import-PSSession $exchangeSession | Out-Null
 
Write-Host "Connected to Exchange Online"

WriteOutputHeader -Output $Output

$auditData = Search-UnifiedAuditLog -StartDate $StartDate -EndDate $EndDate -ResultSize 500 -Operations FileMalwareDetected

foreach ($auditDataEntry in $auditData)
{
    $json = ConvertFrom-Json -InputObject $auditDataEntry.AuditData

    WriteOutputLine -AuditEntry $json -Output $Output
}

Get-PSSession | Where { $_.ConfigurationName -eq "Microsoft.Exchange" } | Remove-PSSession

Write-Host "Disconnected from Exchange Online"

Write-Host -ForegroundColor Green "Done."
